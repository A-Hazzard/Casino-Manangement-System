# Evolution CMS - Cursor AI Context Rules

## Critical System Context

### Licensee & Location Access Control System

**READ FIRST:** `.cursor/licensee-access-context.md` for complete details.

---

## üö® ALWAYS Follow These Rules

### 1. Database Queries
- ‚úÖ Use `findOne({ _id: id })` for finding by ID (String IDs, not ObjectId)
- ‚ùå NEVER use `findById(id)` (it expects ObjectId)
- ‚úÖ Use `findOneAndUpdate({ _id: id }, ...)` for updates
- ‚ùå NEVER use `findByIdAndUpdate(id, ...)`

### 2. API Parameter Handling
- ‚úÖ ALWAYS support both `licensee` and `licencee` spellings:
  ```typescript
  const licensee = searchParams.get('licensee') || searchParams.get('licencee');
  ```
- ‚úÖ ALWAYS filter data by user's accessible licensees/locations
- ‚úÖ ALWAYS use helper functions from `licenseeFilter.ts`

### 3. User Permission Changes
- ‚úÖ ALWAYS increment `sessionVersion` when changing:
  - `rel.licencee` (licensee assignments)
  - `resourcePermissions.gaming-locations.resources` (location permissions)
  - `roles` (user roles)
- ‚úÖ Use `$inc: { sessionVersion: 1 }` in update operations

### 4. Frontend Data Fetching
- ‚úÖ ALWAYS include `selectedLicencee` in API calls
- ‚úÖ ALWAYS add `selectedLicencee` to useEffect dependencies
- ‚úÖ ALWAYS check `shouldShowNoLicenseeMessage(user)` before rendering data

---

## üéØ Role-Based Access Logic

### Who Sees What?

- **Developer/Admin**: ALL data (licensee dropdown is optional filter)
- **Manager**: ALL locations for assigned licensees (no intersection)
- **Collector/Location Admin/Technician**: ONLY intersection of (licensee locations ‚à© assigned locations)

### Dropdown Visibility

- **Always Show**: Developer, Admin
- **Conditionally Show**: Manager (2+ licensees), Collector (2+ licensees)
- **Never Show**: Location Admin, Technician

---

## üìö Key Files to Reference

### Backend Helpers
- `app/api/lib/helpers/licenseeFilter.ts` - Core filtering functions
- `app/api/lib/helpers/users.ts` - User fetching with session validation

### Frontend Utilities
- `lib/utils/licenseeAccess.ts` - Client-side access checks
- `lib/store/dashboardStore.ts` - Licensee selection state
- `components/ui/LicenceeSelect.tsx` - Licensee dropdown

### Documentation
- `.cursor/licensee-access-context.md` - Complete system guide
- `Documentation/licensee-location-filtering.md` - Comprehensive reference

---

## ‚ö° Quick Reference

### Backend Pattern
```typescript
const licensee = searchParams.get('licensee') || searchParams.get('licencee');
const allowedLocationIds = await getUserLocationFilter(licensee || undefined);
if (allowedLocationIds !== 'all') {
  matchStage['gamingLocation'] = { $in: allowedLocationIds };
}
```

### Frontend Pattern
```typescript
if (shouldShowNoLicenseeMessage(currentUser)) {
  return <NoLicenseeAssigned />;
}

const { data } = useQuery({
  queryKey: ['data', selectedLicencee],
  queryFn: () => fetchData({ licensee: selectedLicencee })
});
```

---

**For complete details, see:** `.cursor/licensee-access-context.md`

