import { NextRequest } from 'next/server';
import { authenticateUser } from '@/app/api/lib/helpers/auth';
import { getFriendlyErrorMessage } from '@/lib/utils/auth';
import { getClientIP } from '@/lib/utils/ipAddress';
import { connectDB } from '@/app/api/lib/middleware/db';
import {
  createSuccessResponse,
  createErrorResponse,
  createBadRequestResponse,
  createServerErrorResponse,
} from '@/app/api/lib/utils/apiResponse';

export const runtime = 'nodejs';

/**
 * Enhanced authentication endpoint with rate limiting, session management, and security features.
 *
 * @param request - Incoming request containing credentials and client information
 * @returns JSON response with user data and tokens on success
 */
export async function POST(request: NextRequest) {
  try {
    await connectDB();

    const { identifier, password, rememberMe } = await request.json();

    if (!identifier || !password) {
      return createBadRequestResponse(
        'Email/username and password are required.'
      );
    }

    // Basic input validation
    const isEmail = /\S+@\S+\.\S+/.test(identifier);
    const isUsername =
      !isEmail &&
      typeof identifier === 'string' &&
      identifier.trim().length >= 3;

    if (!(isEmail || isUsername)) {
      return createBadRequestResponse('Invalid identifier format.');
    }

    // Get client information for enhanced security
    const ipAddress = getClientIP(request) || 'unknown';
    const userAgent = request.headers.get('user-agent') || 'unknown';

    const result = await authenticateUser(
      identifier,
      password,
      ipAddress,
      userAgent,
      rememberMe
    );

    if (!result.success) {
      return createErrorResponse(
        result.message || 'Authentication failed',
        401
      );
    }

    // Debug: Log authentication result
    console.warn('üîê Authentication Result:', {
      success: result.success,
      hasToken: !!result.token,
      tokenLength: result.token?.length || 0,
      hasRefreshToken: !!result.refreshToken,
      hasUser: !!result.user,
      userId: result.user?._id,
      userEmail: result.user?.emailAddress,
    });

    // Verify token exists
    if (!result.token) {
      console.error('‚ùå No token generated by authenticateUser!');
      return createServerErrorResponse(
        'Authentication failed - no token generated'
      );
    }

    // Set tokens as HTTP-only cookies
    const response = createSuccessResponse(
      {
        user: result.user,
        expiresAt: result.expiresAt,
      },
      'Login successful'
    );

    console.warn('üç™ Setting token cookie:', {
      tokenPreview: result.token.substring(0, 20) + '...',
      tokenLength: result.token.length,
    });

    // Access token
    response.cookies.set('token', result.token!, {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      path: '/',
      maxAge: 7 * 24 * 60 * 60, // 7 days (matches JWT expiration)
    });

    // Refresh token (long-lived)
    if (result.refreshToken) {
      console.warn('Setting refreshToken cookie:', {
        hasRefreshToken: !!result.refreshToken,
        refreshTokenLength: result.refreshToken.length,
        maxAge: rememberMe ? 30 * 24 * 60 * 60 : 7 * 24 * 60 * 60,
        rememberMe,
      });
      response.cookies.set('refreshToken', result.refreshToken, {
        httpOnly: true,
        secure: process.env.NODE_ENV === 'production',
        sameSite: 'lax',
        path: '/',
        maxAge: rememberMe ? 30 * 24 * 60 * 60 : 7 * 24 * 60 * 60, // 30 days or 7 days
      });
    } else {
      console.warn('No refreshToken in result:', {
        hasToken: !!result.token,
        hasRefreshToken: !!result.refreshToken,
        resultKeys: Object.keys(result),
      });
    }

    console.warn(
      '‚úÖ Login API completed successfully, cookies should be set now'
    );

    return response;
  } catch (error) {
    console.error('Login error:', error);
    return createServerErrorResponse(
      getFriendlyErrorMessage(
        error instanceof Error ? error.message : 'Login failed'
      )
    );
  }
}
