/**
 * Login API Route
 *
 * This route handles user authentication and login functionality.
 * It supports:
 * - Email or username-based login
 * - Password validation
 * - Remember me functionality
 * - JWT token generation
 * - Session management
 * - Profile validation requirements
 * - Password update requirements
 * - Secure cookie management
 *
 * @module app/api/auth/login/route
 */

import { authenticateUser } from '@/app/api/lib/helpers/auth/auth';
import { connectDB } from '@/app/api/lib/middleware/db';
import {
  createBadRequestResponse,
  createErrorResponse,
  createServerErrorResponse,
  createSuccessResponse,
} from '@/app/api/lib/utils/apiResponse';
import { getFriendlyErrorMessage } from '@/lib/utils/auth';
import { getClientIP } from '@/lib/utils/ipAddress';
import { NextRequest } from 'next/server';

export const runtime = 'nodejs';

/**
 * Main POST handler for user login
 *
 * Flow:
 * 1. Connect to database
 * 2. Parse and validate request body
 * 3. Validate identifier format (email or username)
 * 4. Extract client IP and user agent
 * 5. Authenticate user with credentials
 * 6. Generate JWT tokens
 * 7. Set secure authentication cookies
 * 8. Return user data and validation requirements
 */
export async function POST(request: NextRequest) {
  const startTime = Date.now();

  try {
    // ============================================================================
    // STEP 1: Connect to database
    // ============================================================================
    await connectDB();

    // ============================================================================
    // STEP 2: Parse and validate request body
    // ============================================================================
    const { identifier, password, rememberMe } = await request.json();

    // ============================================================================
    // STEP 3: Validate identifier format (email or username)
    // ============================================================================
    if (!identifier || !password) {
      return createBadRequestResponse(
        'Email/username and password are required.'
      );
    }

    const looksLikeEmail = /\S+@\S+\.\S+/.test(identifier);
    const isUsername =
      typeof identifier === 'string' && identifier.trim().length >= 3;

    if (!(looksLikeEmail || isUsername)) {
      return createBadRequestResponse('Invalid identifier format.');
    }

    // ============================================================================
    // STEP 4: Extract client IP and user agent
    // ============================================================================
    const ipAddress = getClientIP(request) || 'unknown';
    const userAgent = request.headers.get('user-agent') || 'unknown';

    // ============================================================================
    // STEP 5: Authenticate user with credentials
    // ============================================================================
    const result = await authenticateUser(
      identifier,
      password,
      ipAddress,
      userAgent,
      rememberMe
    );

    if (!result.success) {
      return createErrorResponse(
        result.message || 'Authentication failed',
        401
      );
    }

    if (!result.token) {
      console.error('âŒ No token generated by authenticateUser!');
      return createServerErrorResponse(
        'Authentication failed - no token generated'
      );
    }

    // ============================================================================
    // STEP 6: Generate JWT tokens and create response
    // ============================================================================
    const response = createSuccessResponse(
      {
        user: result.user,
        expiresAt: result.expiresAt,
        requiresPasswordUpdate: result.requiresPasswordUpdate ?? false,
        requiresProfileUpdate: result.requiresProfileUpdate ?? false,
        invalidProfileFields: result.invalidProfileFields,
        invalidProfileReasons: result.invalidProfileReasons,
      },
      'Login successful'
    );

    // ============================================================================
    // STEP 7: Set secure authentication cookies
    // ============================================================================
    // Clear any existing authentication cookies before setting new ones
    // This ensures old tokens from previous database connections don't persist
    response.cookies.set('token', '', {
      expires: new Date(0),
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      path: '/',
    });
    response.cookies.set('refreshToken', '', {
      expires: new Date(0),
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      path: '/',
    });

    // Set cookies on the response
    const cookieOptions = {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax' as const,
      path: '/',
      maxAge: rememberMe ? 30 * 24 * 60 * 60 : 7 * 24 * 60 * 60, // 30 days if rememberMe, else 7 days
      // Don't set domain - let browser use default (current domain)
    };

    // Set token cookie
    response.cookies.set('token', result.token!, cookieOptions);

    if (result.refreshToken) {
      const refreshCookieOptions = {
        httpOnly: true,
        secure: process.env.NODE_ENV === 'production',
        sameSite: 'lax' as const,
        path: '/',
        maxAge: rememberMe ? 30 * 24 * 60 * 60 : 7 * 24 * 60 * 60,
      };
      response.cookies.set(
        'refreshToken',
        result.refreshToken,
        refreshCookieOptions
      );
    }

    const duration = Date.now() - startTime;
    if (duration > 1000) {
      console.warn(`[Login API] Completed in ${duration}ms`);
    }

    return response;
  } catch (error) {
    const duration = Date.now() - startTime;
    console.error(`[Login API] Error after ${duration}ms:`, error);
    return createServerErrorResponse(
      getFriendlyErrorMessage(
        error instanceof Error ? error.message : 'Login failed'
      )
    );
  }
}

